CREATE OR REPLACE TABLE main.shared.fiscal_calendar_445 AS
WITH params AS (
  SELECT
    to_date('2024-02-04') AS start_date,   -- First day of FY1
    10 AS num_years
),
leap_years AS (
  SELECT explode(array(3, 8)) AS fiscal_year
),
fy AS (
  SELECT
    fy.fiscal_year,
    p.start_date,
    date_add(
      p.start_date,
      (
        SELECT COALESCE(SUM(fy_days), 0)
        FROM (
          SELECT
            y AS prior_fy,
            CASE 
              WHEN exists(SELECT 1 FROM leap_years ly WHERE ly.fiscal_year = y)
              THEN 371 ELSE 364 
            END AS fy_days
          FROM (
            SELECT explode(sequence(1, fy.fiscal_year - 1)) AS y
          )
        )
      )
    ) AS fy_start_date,
    CASE 
      WHEN exists(SELECT 1 FROM leap_years ly WHERE ly.fiscal_year = fy.fiscal_year)
      THEN 371 ELSE 364 
    END AS fy_days
  FROM params p
  CROSS JOIN (SELECT explode(sequence(1, (SELECT num_years FROM params))) AS fiscal_year) fy
),
days AS (
  SELECT
    fiscal_year,
    explode(sequence(fy_start_date, date_add(fy_start_date, fy_days - 1), interval 1 day)) AS calendar_date,
    fy_start_date
  FROM fy
),
d AS (
  SELECT
    fiscal_year,
    calendar_date,
    fy_start_date,
    datediff(calendar_date, fy_start_date) + 1 AS fiscal_day_of_year,
    cast(floor((datediff(calendar_date, fy_start_date)) / 7) + 1 as int) AS fiscal_week_of_year,
    cast(((floor(datediff(calendar_date, fy_start_date)/7)) % 13) + 1 as int) AS fiscal_week_of_quarter,
    cast(floor((floor(datediff(calendar_date, fy_start_date)/7)) / 13) + 1 as int) AS fiscal_quarter
  FROM days
),
periods AS (
  SELECT
    *,
    CASE
      WHEN fiscal_week_of_quarter BETWEEN 1 AND 4 THEN 1
      WHEN fiscal_week_of_quarter BETWEEN 5 AND 8 THEN 2
      ELSE 3
    END AS fiscal_period_in_quarter
  FROM d
)
SELECT
  calendar_date,
  fiscal_year,
  fiscal_quarter,
  (fiscal_quarter - 1) * 3 + fiscal_period_in_quarter AS fiscal_period,
  fiscal_week_of_year,
  fiscal_week_of_quarter,
  fiscal_day_of_year,
  concat('FY', lpad(cast(fiscal_year as string), 2, '0')) AS fiscal_year_label,
  concat('FY', lpad(cast(fiscal_year as string), 2, '0'),
         '-Q', cast(fiscal_quarter as string)) AS fiscal_quarter_label,
  concat('P', lpad(cast(((fiscal_quarter - 1) * 3 + fiscal_period_in_quarter) as string), 2, '0')) AS fiscal_period_label
FROM periods
ORDER BY calendar_date;
